# Sber HomeWork (sbrHW)

  
## Тестовый стенд

- Windows 10 Pro

- VirtualBox 6.1

- Vagrant 2.2.19


## Процесс
Процесс выполнения полностью автоматизирован, от создания виртуальных машин, до добавления задач в Jenkins и их выполнения.

Точкой входа является doHomeWork.bat

## Результаты
Все требуемые результаты, в том числе файл sshd_config с ВМ2, помещаются в папку log. Логи выполнения плэйбуков: play.sbrHW.log, play.task.log ; лог выболнения job: job.sbrHW-VM2.log

**doHomeWork.bat**
Сначала, в соответствии с конфигом Vagrantfile, создаются 3 виртуалные машины:

- sbrHW-Ansible - для развертывания Ansible (ubuntu 20)
- sbrHW-VM1 - для сервера Jenkins (CentOs 7)
- sbrHW-VM2 - для выполнения действий по заданию на нем (CentOs 7)
  
В процессе создания ВМ, возможно потребуется несколько раз подтвердить повышение прав VirtualBox для настройки сетевых адаптеров.

На все машины распространяется открытый ключ. К серверу sbrHW-Ansible монтируется папка проекта.

После этого, на сервере sbrHW-Ansible запускается bash-скрипт *doAnsible.sh* , по завершении которого, все виртуальные машины удаляются.

**doAnsible.sh**
Этот скрипт производит установку и настройку Ansible, файловой структуры ролей (*role.java.yml*, *role.jenkins.yml*), а также  подключение файла закрытого ключа ssh из папки keys.
После чего воспроизводятся плэйбуки play.sbrHW.yml и play.task.yml .  Первый задает инфраструктуру, второй - реализует конкретные действия, разово решающие одну задачу. Поэтому их было бы идеологически не правильно объединять в один.
play.task.yml - размещает на sbrHW-VM1 файлы с объектами Jenkins,  удаленно запускает скрипт doJenkins.sh. После завершения которого, забирает файлы логов и размещает их в папке logs проекта.

**doJenkins.sh**
Используя Jenkins CLI устанавливает в Jenkins лишь минимально требуемые плагины, импортирует данные подключения, узлов, Подключается к узлу sbrHW-VM2 и выполняет задачу. После чего происходит выход и сбор логов
